# This pipeline is triggered on every push to the 'main' branch.
trigger:
- main

variables:
  # This links your secret variable group
  - group: WebApp-Secrets

  # These define the other pipeline variables
  - name: azureServiceConnection
    value: 'AzureStudentSubscription' 
  - name: resourceGroupName
    value: 'cloud-project'                
  - name: backendAppName
    value: 'achievement-log'        
  - name: frontendAppName
    value: 'achievement-log'      
  - name: frontendFolder
    value: 'frontend'
  - name: serverFolder
    value: 'server'

stages:
- stage: Build
  displayName: 'Build Stage'
  pool:
    vmImage: 'ubuntu-latest'
  jobs:
  - job: Build_Frontend
    displayName: 'Build Frontend Artifact'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js 20.x'

    - task: CodeQL.ql-actions-init@1
      displayName: 'Initialize CodeQL'
      inputs:
        languages: 'javascript'
        source-root: '$(frontendFolder)'

    - task: CodeQL.ql-actions-autobuild@1
      displayName: 'CodeQL Autobuild'

    - task: CodeQL.ql-actions-analyze@1
      displayName: 'Perform CodeQL Analysis'

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Frontend Artifact'
      inputs:
        targetPath: '$(frontendFolder)/dist'
        artifact: 'frontend_dist'

  - job: Build_Server
    displayName: 'Build Server Artifact'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js 20.x'

    - task: CodeQL.ql-actions-init@1
      displayName: 'Initialize CodeQL'
      inputs:
        languages: 'javascript'
        source-root: '$(serverFolder)'

    - task: CodeQL.ql-actions-autobuild@1
      displayName: 'CodeQL Autobuild'

    - task: CodeQL.ql-actions-analyze@1
      displayName: 'Perform CodeQL Analysis'

    - task: ArchiveFiles@2
      displayName: 'Archive Server Files'
      inputs:
        rootFolderOrFile: '$(serverFolder)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/server.zip'

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Server Artifact'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/server.zip'
        artifact: 'server_dist'

- stage: Deploy
  displayName: 'Deploy Stage'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: Deploy_Services
    displayName: 'Deploy to Azure'
    environment: 'production'
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Download All Artifacts'
            inputs:
              path: '$(Pipeline.Workspace)'

          - task: AzureWebApp@1
            displayName: 'Deploy Backend to App Service'
            inputs:
              azureSubscription: $(azureServiceConnection)
              appType: 'webAppLinux'
              appName: $(backendAppName)
              package: '$(Pipeline.Workspace)/server_dist/server.zip'
              runtimeStack: 'NODE|20-lts'

          - task: AzureAppServiceSettings@1
            displayName: 'Update Backend App Settings with Secrets'
            inputs:
              azureSubscription: $(azureServiceConnection)
              appName: $(backendAppName)
              resourceGroupName: $(resourceGroupName)
              appSettings: |
                [
                  { "name": "PORT", "value": "$(PORT)", "slotSetting": false },
                  { "name": "ADMIN_USERNAME", "value": "$(ADMIN_USERNAME)", "slotSetting": false },
                  { "name": "ADMIN_PASSWORD", "value": "$(ADMIN_PASSWORD)", "slotSetting": false },
                  { "name": "DUMMY_TOKEN", "value": "$(DUMMY_TOKEN)", "slotSetting": false },
                  { "name": "COSMOS_ENDPOINT", "value": "$(COSMOS_ENDPOINT)", "slotSetting": false },
                  { "name": "COSMOS_KEY", "value": "$(COSMOS_KEY)", "slotSetting": false },
                  { "name": "COSMOS_DATABASE_ID", "value": "$(COSMOS_DATABASE_ID)", "slotSetting": false },
                  { "name": "COSMOS_CONTAINER_ID", "value": "$(COSMOS_CONTAINER_ID)", "slotSetting": false }
                ]

          - script: |
              npm install -g @azure/static-web-apps-cli
              swa deploy --app-location ./frontend_dist --deployment-token $(deployment_token)
            displayName: 'Deploy Frontend via SWA CLI'
            workingDirectory: '$(Pipeline.Workspace)'

  - job: ZAP_Scan
    displayName: 'OWASP ZAP Scan'
    dependsOn: Deploy_Services
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        docker run --rm -v $(Pipeline.Workspace):/zap/wrk/:rw owasp/zap2docker-stable zap-baseline.py -t https://zealous-meadow-02e133900-preview.eastasia.1.azurestaticapps.net/ -g gen.conf -r report.html
      displayName: 'Run ZAP Baseline Scan'

    - task: PublishPipelineArtifact@1
      displayName: 'Publish ZAP Report'
      inputs:
        targetPath: '$(Pipeline.Workspace)/report.html'
        artifact: 'ZAP_Report'
